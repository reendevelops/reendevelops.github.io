<! DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../css/content.css">
</head>

<body>
    <div class="background">

        <h1>Begin the journey!</h1>
        <p id="mousePos">Mouse pos: </p>
        <p id="mouseTest">Mouse press: </p>
        <p id="position">Circle position: </p>
        <p id="hitbox">Hitbox: </p>

        <canvas id="mainCanvas" width="1920" height="1080"></canvas>

        <script>
            const canvas = document.getElementById("mainCanvas");
            const canvasWidth = 1920;
            const canvasHeight = 1080;
            const aspectRatio = canvasWidth / canvasHeight; // your fixed ratio (e.g., 800x450)
            const ctx = canvas.getContext("2d");

            // Define a rect for hitboxes.
            class Hitbox {
                constructor(x, y, width, height, color) {
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                    this.color = color;
                    this.upperEdge = this.y;
                    this.lowerEdge = this.y + this.height;
                    this.leftEdge = this.x;
                    this.rightEdge = this.x + this.width;
                    this.upperEdgePos = { x: this.x, y: this.upperEdge };
                    this.lowerEdgePos = { x: this.x, y: this.lowerEdge };
                    this.leftEdgePos = { x: this.leftEdge, y: this.y };
                    this.rightEdgePos = { x: this.rightEdge, y: this.y };
                }
            };

            // Define an animated image class.
            class Animation {
                constructor(animationSpeed) {
                    this.frames = [];
                    this.animationSpeed = animationSpeed;
                }
            }

            // Create the upper hitbox.
            const upperHitbox = new Hitbox(0, 0, 1920, 400, "blue");

            document.getElementById("hitbox").innerHTML = "Hitbox: " + upperHitbox.upperEdge + " " + upperHitbox.lowerEdge + " " + upperHitbox.leftEdge + " " + upperHitbox.rightEdge;


            // Starting position.
            let playerPos = { x: 190, y: 420 };
            let moveSpeed = 0.5;

            // Mouse position.
            let mousePos = { x: 0, y: 0 };
            let isPressed = false;

            // Destination position.
            let destination = { x: playerPos.x, y: playerPos.y };
            let distanceAllowance = 5; // how close is close enough


            // Load the asset images.
            const journey1 = new Image();
            journey1.src = "../img/journey1.png";
            journey1.onload = function () { requestAnimationFrame(update); };


            // Load the RIGHT player animation frames.
            const playerImage_r1 = new Image();
            const playerImage_r2 = new Image();
            const playerImage_r3 = new Image();
            const playerImage_r4 = new Image();
            playerImage_r1.src = "../img/player_r1.png";
            playerImage_r2.src = "../img/player_r2.png";
            playerImage_r3.src = "../img/player_r3.png";
            playerImage_r4.src = "../img/player_r4.png";
            playerImage_r1.onload = function () { requestAnimationFrame(update); };
            playerImage_r2.onload = function () { requestAnimationFrame(update); };
            playerImage_r3.onload = function () { requestAnimationFrame(update); };
            playerImage_r4.onload = function () { requestAnimationFrame(update); };
            // Create the animation object.
            const playerAnim_r = new Animation(0.2);
            playerAnim_r.frames.push(playerImage_r1);
            playerAnim_r.frames.push(playerImage_r2);
            playerAnim_r.frames.push(playerImage_r3);
            playerAnim_r.frames.push(playerImage_r4);

            // Load the LEFT player animation frames.
            const playerImage_l1 = new Image();
            const playerImage_l2 = new Image();
            const playerImage_l3 = new Image();
            const playerImage_l4 = new Image();
            playerImage_l1.src = "../img/player_l1.png";
            playerImage_l2.src = "../img/player_l2.png";
            playerImage_l3.src = "../img/player_l3.png";
            playerImage_l4.src = "../img/player_l4.png";
            playerImage_l1.onload = function () { requestAnimationFrame(update); };
            playerImage_l2.onload = function () { requestAnimationFrame(update); };
            playerImage_l3.onload = function () { requestAnimationFrame(update); };
            playerImage_l4.onload = function () { requestAnimationFrame(update); };
            // Create the animation object.
            const playerAnim_l = new Animation(0.2);
            playerAnim_l.frames.push(playerImage_l1);
            playerAnim_l.frames.push(playerImage_l2);
            playerAnim_l.frames.push(playerImage_l3);
            playerAnim_l.frames.push(playerImage_l4);


            // Detect mouse movement.
            canvas.addEventListener("mousemove", (event) => {
                const rect = canvas.getBoundingClientRect(); // Canvas position on page.

                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                mousePos.x = (event.clientX - rect.left) * (canvasWidth / rect.width);
                mousePos.y = (event.clientY - rect.top) * (canvasHeight / rect.height);

                document.getElementById("mousePos").innerHTML = "Mouse pos: " + mousePos.x + ", " + mousePos.y;
            });

            // Detect mouse press.
            canvas.addEventListener("mousedown", () => {
                isPressed = true;

                // Set destination on click.
                const rect = canvas.getBoundingClientRect(); // Canvas position on page.

                destination.x = (event.clientX - rect.left) * (canvasWidth / rect.width);
                destination.y = (event.clientY - rect.top) * (canvasHeight / rect.height);

                document.getElementById("mouseTest").innerHTML = "Mouse press: " + destination.x + ", " + destination.y;
            });

            // Detect mouse release.
            canvas.addEventListener("mouseup", () => {
                isPressed = false;
            });

            function update() {
                // Resize canvas.
                resizeCanvas();

                // Clear the previous frame.
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Resize assets to scale with canvas size.
                resizeAssets();

                // Everything drawn now scales perfectly.
                const scaleX = canvas.width / canvasWidth;
                const scaleY = canvas.height / canvasHeight;
                ctx.save();
                ctx.scale(scaleX, scaleY); 

                // Always move the player towards the destination
                const dx = destination.x - playerPos.x;
                const dy = destination.y - playerPos.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                // If playerPos is inside a hitbox, move it outside.
                if (isInsideHitbox(upperHitbox, playerPos))
                    playerPos = getPositionOutsideHitbox(upperHitbox, playerPos);

                // Move playerPos toward destination if not too close
                if (distance > distanceAllowance) {
                    playerPos.x += (dx / distance) * moveSpeed;
                    playerPos.y += (dy / distance) * moveSpeed;
                }
                document.getElementById("position").innerHTML = "Player position: " + playerPos.x + ", " + playerPos.y;

                // If player is heading left.
                if (destination.x < playerPos.x)
                    ctx.drawImage(playerImage_l1, playerPos.x - playerImage_l1.width / 4, playerPos.y - playerImage_l1.height / 2.5, playerImage_l1.width / 2, playerImage_l1.height / 2);
                else
                    ctx.drawImage(playerImage_r1, playerPos.x - playerImage_r1.width / 4, playerPos.y - playerImage_r1.height / 2.5, playerImage_r1.width / 2, playerImage_r1.height / 2);

                // Draw a circle following the mouse
                ctx.beginPath();
                ctx.arc(mousePos.x, mousePos.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = "rgba(232, 100, 27, 0.5)";
                ctx.fill();

                // Draw the hitboxes.
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
                ctx.strokeRect(upperHitbox.x, upperHitbox.y, upperHitbox.width, upperHitbox.height);

                // For the scaling.
                ctx.restore();

                // Call draw() again for the next frame.
                requestAnimationFrame(update);
            }


            // Return what player animation frame should be drawn.
            function getPlayerImage(xDestination, xPlayerPos) {
                if (xDestination < xPlayerPos) {

                }
            }

            function isInsideHitbox(hitbox, canvasPos) {
                if (canvasPos.x < hitbox.rightEdge && canvasPos.x > hitbox.leftEdge)
                    if (canvasPos.y > hitbox.upperEdge && canvasPos.y < hitbox.lowerEdge)
                        return true;
                return false;
            }

            function getPositionOutsideHitbox(hitbox, originalPos) {
                // Get closest edge from originalPos.
                let closestEdgePos = { x: originalPos.x, y: hitbox.upperEdgePos.y };

                // Lower
                let lowerEdgePos = { x: originalPos.x, y: hitbox.lowerEdgePos.y };
                if (distance(originalPos, closestEdgePos) > distance(originalPos, lowerEdgePos))
                    closestEdgePos = lowerEdgePos;

                // Left
                let leftEdgePos = { x: hitbox.leftEdgePos.x, y: originalPos.y };
                if (distance(originalPos, closestEdgePos) > distance(originalPos, leftEdgePos))
                    closestEdgePos = leftEdgePos;

                // Right
                let rightEdgePos = { x: hitbox.rightEdgePos.x, y: originalPos.y };
                if (distance(originalPos, closestEdgePos) > distance(originalPos, rightEdgePos))
                    closestEdgePos = rightEdgePos;

                return closestEdgePos;
            }

            function distance(a, b) {
                let dx = b.x - a.x;
                let dy = b.y - a.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            function resizeAssets() {
                ctx.drawImage(journey1, 0, 0, canvas.width, canvas.height);
            }

            function resizeCanvas() {
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const windowRatio = windowWidth / windowHeight;

                if (windowRatio > aspectRatio) {
                    // Window is wider than your ratio = match height
                    canvas.height = windowHeight;
                    canvas.width = windowHeight * aspectRatio;
                } else {
                    // Window is taller than your ratio = match width
                    canvas.width = windowWidth;
                    canvas.height = windowWidth / aspectRatio;
                }

                // Center the canvas.
                canvas.style.position = "absolute";
                canvas.style.left = `${(windowWidth - canvas.width) / 2}px`;
                canvas.style.top = `${(windowHeight - canvas.height) / 2}px`;
            }

            // Start animation.
            update();
        </script>
    </div>

</body>
</html>
